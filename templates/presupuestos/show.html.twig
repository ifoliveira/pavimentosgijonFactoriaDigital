{% extends 'pages.html.twig' %}
{% form_theme form 'fields.html.twig' %}
{% block cabecera %} Presupuestos {% endblock %}
{% block breadcrumb %} <li class="breadcrumb-item active">Presupuestos List</li>{% endblock %}
{% block title %}Presupuestos List{% endblock %}
{% block tablas %}
                <!-- ============================================================== -->
                <!-- Start Page Content -->
                <!-- ============================================================== -->
                <!-- basic table -->
                <div class="row">
                    <div class="col-lg-8">
            

                        {% if presupuesto.EstadoPe.id > 3 and presupuesto.EstadoPe.id < 8 %}
                                    <div class="card">
                                        <div class="card-body">
                                            {{ form_start(formestado) }}
                                                    {{ form_row(formestado._token) }}
                                                    {% if presupuesto.EstadoPe.id == 4 %}
                                                    <h4 class="card-title">¿Ya se ha medido e incorporado fotos?</h4>
                                                    <button type="submit" class="btn btn-rounded btn-outline-success">Medir finalizado </button>
                                                    {% endif %} 
                                                    {% if presupuesto.EstadoPe.id == 5 %}
                                                    <h4 class="card-title">¿Se han escogido los materiales?</h4>
                                                    <button type="submit" class="btn btn-rounded btn-outline-success">Escoger finalizado </button>
                                                    {% endif %} 
                                                    {% if presupuesto.EstadoPe.id == 6 %}
                                                    <h4 class="card-title">¿Presupuesto finalizado?</h4>
                                                    <button type="submit" class="btn btn-rounded btn-outline-success">Presupuesto finalizado </button>
                                                    {% endif %} 
                                                    {% if presupuesto.EstadoPe.id == 7 %}
                                                    <h4 class="card-title">¿Presupuesto Entregado?</h4>
                                                    <button type="submit" class="btn btn-rounded btn-outline-success">Entregar presupuesto</button>
                                                    
                                                    {% endif %} 
                                                    {{ form_row(formestado.manoobraPe | raw, { 'row_attr': {'class': 'd-none'} })  }}
                                                    {{ form_row(formestado.importetotPe, { 'row_attr': {'class': 'd-none'} }) }}
                                                    {{ form_row(formestado.importemanoobra, { 'row_attr': {'class': 'd-none'} }) }}
                                                    {{ form_row(formestado.descuaetoPe, { 'row_attr': {'class': 'd-none'} }) }}
                                            {{ form_end(formestado, {'render_rest': false}) }}

                                        </div>
                                    </div>

                        {% endif %}

                        {% if presupuesto.EstadoPe.id < 7 %}
                                    <div class="card">
                                        <div class="card-body">
                                             <a href="{{ path('mano_obra_new', {presu: presupuesto.id}) }}" target=""  class="btn btn-rounded btn-outline-danger "> Añadir mano de obra</a>
                                        </div>
                                    </div>
                        {% endif %}

                        {% if presupuesto.EstadoPe.id == 7 %}
                                    <div class="card">
                                        <div class="card-body">
                                             <a href="{{ path('presupuestos_generar', {id: presupuesto.id, precios: 'S', tipo : 'PRESUPUESTO'}) }}" target="_blank"  class="btn btn-rounded btn-outline-danger "> Presupuesto CON precios</a>
                                             <a href="{{ path('presupuestos_generar', {id: presupuesto.id, precios: 'N', tipo : 'PRESUPUESTO'}) }}" target="_blank"  class="btn btn-rounded btn-outline-danger "> Presupuesto SIN precios</a>
                                        </div>
                                    </div>
                        {% endif %}
                        {% if presupuesto.EstadoPe.id == 8 %}

                                    <div class="card">
                                        <div class="card-body">
                                            <button id="Aceptar" class="btn btn-rounded btn-outline-success " data-importe="{{presupuesto.importetotPe}}">Aceptar</button>
                                            <button id="Rechazar" class="btn btn-rounded btn-outline-danger " data-importe="{{presupuesto.importetotPe}}">Rechazar</button>
                                        </div>
                                    </div>

                                    <div class="card">
                                        <div class="card-body">
                                             <a href="{{ path('presupuestos_generar', {id: presupuesto.id, precios: 'S', tipo : 'PRESUPUESTO'}) }}" target="_blank"  class="btn btn-rounded btn-outline-danger "> Presupuesto CON precios</a>
                                             <a href="{{ path('presupuestos_generar', {id: presupuesto.id, precios: 'N', tipo : 'PRESUPUESTO'}) }}" target="_blank"  class="btn btn-rounded btn-outline-danger "> Presupuesto SIN precios</a>
                                        </div>
                                    </div>
                        {% endif %}

                        {% if presupuesto.EstadoPe.id == 9 %}

                                    <div class="card">
                                        <div class="card-body">
                                            <button id="Finalizar" class="btn btn-rounded btn-outline-success " data-importe="{{presupuesto.importetotPe}}">Finalizar</button>
                                            <button id="Modificar" class="btn btn-rounded btn-outline-success " data-importe="{{presupuesto.importetotPe}}">Modificar</button>
                                            
                                        </div>
                                    </div>
                                    <div class="card">
                                        <div class="card-body">
                                             <a href="{{ path('presupuestos_generar', {id: presupuesto.id, precios: 'S', tipo : 'FACTURA SIMPLIFICADA'}) }}" target="_blank"  class="btn btn-rounded btn-outline-danger "> Factura CON precios</a>
                                             <a href="{{ path('presupuestos_generar', {id: presupuesto.id, precios: 'N', tipo : 'FACTURA SIMPLIFICADA'}) }}" target="_blank"  class="btn btn-rounded btn-outline-danger "> Factura SIN precios</a>
                                        </div>
                                    </div>
                        {% endif %}

                        {% if presupuesto.EstadoPe.id == 10 %}

                                    <div class="card">
                                        <div class="card-body">
                                            <a href="/Tickets/{{ presupuesto.ticket.numticketCs }}" target="_blank"  class="btn btn-rounded btn-outline-danger "> Ticket final </a>
                                        </div>
                                    </div>
                        {% endif %}

                        {% if presupuesto.EstadoPe.id == 6 %}
                         <div class="card">
                            <div class="card-body">
  

                                <h3 class="card-title">PRODUCTOS</h3>
                                <h6 class="card-subtitle"></h6>
                                <div class="table-responsive">
                                    <table id="tbprod" class="table table-striped table-bordered text-inputs-searching">
                                         <thead>
                                             <tr>
                                                 <th>Id</th>
                                                 <th>tipo</th>        
                                                 <th>Descripcion</th>
                                                 <th>Precio</th>
                                                 <th>PVP</th>
                                                 <th>Stock</th>
                                             </tr>
                                         </thead>
                                         <tbody>
                                             {% for producto in productos %}
                                                 <tr>
                                                     <td>{{ producto.id }}</td>
                                                     <td>{{ producto.tipoPdId}}</td>
                                                     <td>{{ producto.descripcionPd }}</td>
                                                     <td>{{ producto.precioPd }}</td>
                                                     <td>{{ producto.pvpPd }}</td>
                                                     <td>{{ producto.stockPd }}</td>
                                                 </tr>
                                             {% else %}
                                                 <tr>
                                                     <td colspan="8">no records found</td>
                                                 </tr>
                                             {% endfor %}
                                         </tbody>
                                         <tfoot>
                                             <tr>
                                                 <th>Id</th>
                                                 <th>tipo</th>        
                                                 <th>Descripcion</th>
                                                 <th>Precio</th>
                                                 <th>PVP</th>
                                                 <th>Stock</th>
                                             </tr>
                                         </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}


                       {% if presupuesto.EstadoPe.id == 7  or presupuesto.EstadoPe.id == 6 %}

                                    <div class="card">
                                        <div class="card-body">
                                        {{ form_start(formmanoob) }}
                                                {{ form_row(formmanoob._token) }}


                                            <div class="card-body">
                                            <h6 class="card-subtitle"></code></h6>
                                            <div class="action-form">
                                                <div class="form-group mb-0 text-left">
                                                    <button type="submit"  class="btn btn-info waves-effect waves-light">{{ button_label|default('Actualizar PVP') }}</button>
                                                </div>
                                            </div>
                                            <hr>
                                                {{ form_row(formmanoob.estadoPe, { 'row_attr': {'class': 'd-none'} }) }}
                                                {{ form_row(formmanoob.manoobraPe, { 'row_attr': {'class': 'd-none'} }) }}
                                                {{ form_row(formmanoob.importetotPe, { 'row_attr': {'class': 'd-none'} }) }}
                                                {{ form_row(formmanoob.clientePe, { 'row_attr': {'class': 'd-none'} }) }}
                                                {{ form_row(formmanoob.importemanoobra) }}
                                                {{ form_row(formmanoob.descuaetoPe)}}
                                        {{ form_end(formmanoob, {'render_rest': false}) }}
                                        </div>
                                        </div>
                                    </div>
                       {% endif %}



                        
                        {% if presupuesto.EstadoPe.id == 4 %}   
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Subir fotos</h4>
                                    {{ form_start(form) }}
                                        
                                            <div class="card-body">
                                            <h6 class="card-subtitle"></code></h6>
                                            <div class="action-form">
                                                <div class="form-group mb-0 text-left">
                                                    <button type="submit"  class="btn btn-info waves-effect waves-light">{{ button_label|default('Guardar Foto') }}</button>
                                                </div>
                                            </div>
                                            <hr>
                                    
                                    {{ form_end(form) }}
                                    </div>
                                </div>
                            </div>
                        {% endif %}  



                    {% if presupuesto.EstadoPe.id > 6 %} 
                        <div class="card">
                            <div class="card-body">

                            <h4 class="card-title">Tickets</h4>
                                <h6 class="card-subtitle"></h6>
                                <div class="table-responsive">
                                    <table id="default_order" class="table table-striped table-bordered display"
                                        style="width:100%">
                                            <thead>
                                                <tr>
                                                    <th>Id</th>
                                                    <th>Concepto</th>
                                                    <th>Importe Total</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                             {% for economicos in economic %}
                                                <tr>
                                                    <td>{{ economicos.id }}</td>
                                                    <td>{{ economicos.conceptoEco}}</td>
                                                    {% if economicos.debehaberEco == 'D'  %}
                                                        <td align="right">{{ (economicos.importeEco * -1)|format_currency('EUR', locale='es')}}</td>
                                                    {% else %}
                                                        <td align="right">{{ economicos.importeEco|format_currency('EUR', locale='es')}}</td>
                                                    {% endif %}

                                                    {% if economicos.estadoEco == '1' %}
                                                        <td>Pendiente</td>
                                                        <td>
                                                            {% if economicos.aplicaEco == 'T' %}
                                                                <i class="text-inverse pr-2" data-toggle="tooltip" title="Tratar movimiento" name="ticket_material" id="{{ economicos.id }}" data-importe="{{ economicos.importeEco }}"><i class="ti-money"></i></i>                                                        
                                                            {% else %}
                                                                {% if economicos.aplicaEco == 'M' %}
                                                                    <i class="text-inverse pr-2" data-toggle="tooltip" title="Tratar movimiento" name="ticket_mano" id="{{ economicos.id }}" data-importe="{{ economicos.importeEco}}" ><i class="ti-money"></i></i>                                                        
                                                                {% else %}
                                                                    <i class="text-inverse pr-2" data-toggle="tooltip" title="Tratar movimiento" name="cambiar_importe" id="{{ economicos.id }}" data-importe="{{ economicos.importeEco}}"><i class="ti-money"></i></i>                                                        
                                                                {% endif %}    
                                                            {% endif %}
                                                            
                                                            <i class="text-inverse pr-2" data-toggle="tooltip" title="Cambiar a no aplica" name="no_aplica" id="{{ economicos.id }}" data-estado= "9"><i class="ti-thumb-down"></i></i>

                                                        </td>    
                                                    {% elseif economicos.estadoEco == '9' %}
                                                        <td>No aplica</td>
                                                        <td><i class="text-inverse pr-2" data-toggle="tooltip" title="Cambiar a aplica" name="no_aplica" id="{{ economicos.id }}" data-estado= "1"><i class="ti-thumb-up"></i></td>                                                                                                        
                                                    {% elseif economicos.estadoEco == '8' %}
                                                        <td>Pagado</td>
                                                        <td></td>
                                                    {% elseif economicos.estadoEco == '7' %}
                                                        <td>Cobrado con tarjeta</td>
                                                        <td></td>                                                        
                                                    {% elseif economicos.estadoEco == '6' %}
                                                        <td>Cobrado</td>
                                                        <td></td>                                                        
                                                    {% else %}
                                                        <td>{{ economicos.estadoEco}}</td>
                                                        <td></td>
                                                    {% endif %}

                                                    
                                                        
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                </div>   
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Presupuesto Actual</h4>
                                <h6 class="card-subtitle"></h6>
                                <div class="table-responsive">
                                    <table id="footer" class="table table-striped table-bordered display"
                                        style="width:100%">
                                        <thead>
                                            <tr align="center"> 
                                                <th>Detalle</th>
                                                <th>Precio</th>
                                                <th>Unidades</th>
                                                <th>PVP</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for detalle in project.getCesta(cestaId).getdetallecesta %}
                                            <tr>
                                                <td>{{ detalle.productoDc.descripcionPd }}</td>
                                                <td align="right">{{ detalle.pvpDc |format_currency('EUR', locale='es') }}</td>
                                                <td align="center">{{ detalle.cantidadDC}}</td>
                                                
                                                <td align="right">{{ (detalle.cantidadDC * detalle.pvpDc)|format_currency('EUR', locale='es') }}</td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="7">no records found</td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th colspan="3" style="text-align:right">Total:</th>
                                                <th style="text-align:right">{{project.getImporteTot(cestaId)|format_currency('EUR', locale='es')  }}</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                   
                                </div>
                            </div>
                        </div>
                    {% endif %} 
                    {% if presupuesto.EstadoPe.id > 6 and  presupuesto.EstadoPe.id < 9 %} 
                        <div class="card">
                            <div class="card-body">
  

                                <h3 class="card-title">PRODUCTOS</h3>
                                <h6 class="card-subtitle"></h6>
                                <div class="table-responsive">
                                    <table id="tbprod" class="table table-striped table-bordered text-inputs-searching">
                                         <thead>
                                             <tr>
                                                 <th>Id</th>
                                                 <th>tipo</th>        
                                                 <th>Descripcion</th>
                                                 <th>Precio</th>
                                                 <th>PVP</th>
                                                 <th>Stock</th>
                                             </tr>
                                         </thead>
                                         <tbody>
                                             {% for producto in productos %}
                                                 <tr>
                                                     <td>{{ producto.id }}</td>
                                                     <td>{{ producto.tipoPdId}}</td>
                                                     <td>{{ producto.descripcionPd }}</td>
                                                     <td>{{ producto.precioPd }}</td>
                                                     <td>{{ producto.pvpPd }}</td>
                                                     <td>{{ producto.stockPd }}</td>
                                                 </tr>
                                             {% else %}
                                                 <tr>
                                                     <td colspan="8">no records found</td>
                                                 </tr>
                                             {% endfor %}
                                         </tbody>
                                         <tfoot>
                                             <tr>
                                                 <th>Id</th>
                                                 <th>tipo</th>        
                                                 <th>Descripcion</th>
                                                 <th>Precio</th>
                                                 <th>PVP</th>
                                                 <th>Stock</th>
                                             </tr>
                                         </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        

                        {% endif %}

                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Mano de Obra - {{ presupuesto.importemanoobra |format_currency('EUR', locale='es') }}</h4>
                                <h6 class="card-subtitle"></h6>
                                <div class="table-responsive">
                                    <table id="footer" class="table table-striped table-bordered display"
                                        style="width:100%">
                                        <thead>
                                            <tr align="center"> 
                                                <th>Tipo</th>
                                                <th>Detalle</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for manodeobra in presupuesto.manoObra %}
                                            <tr>
                                                <td>{{ manodeobra.categoriaMo.TipoTm}}</td>
                                                <td align="left">{{ manodeobra.textoMo}}</td>
                                                <td>
                                                        <a href="{{ path('mano_obra_edit', {'id': manodeobra.id}) }}" class="text-inverse pr-2"
                                                                data-toggle="tooltip" title="Modificar">
                                                                <i class="ti-reload"></i>
                                                        </a>                                                         
                                                        <i class="text-inverse pr-2" data-toggle="tooltip" title="Borrar mano de obra" name="delete_detallemo" id="{{ manodeobra.id }}">
                                                                <i class="ti-trash"></i>
                                                        </i> 
                                                </td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="7">no records found</td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                     <a href="{{ path('mano_obra_new' , {'presu' : presupuesto.id}) }}">Nuevo</a>
                                </div>
                            </div>
                        </div>
                        {% if presupuesto.EstadoPe.id == 6 %}
                         
                            <div class="card">
                                {{ form_start(formprod) }}
                                    
                                        <div class="card-body">
                                        <h6 class="card-subtitle"></code></h6>
                                        <div class="action-form">
                                            <div class="form-group mb-0 text-left">
                                                <button type="submit"  class="btn btn-info waves-effect waves-light">{{ button_label|default('Save') }}</button>
                                            </div>
                                        </div>
                                        <hr>
                                
                                {{ form_end(formprod) }}
                                    </div>
                            </div>

                    {% endif %}                        

                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Ticket Info</h4>
                            </div>
                            <div class="card-body bg-light">
                                <div class="row text-center">
                                    <div class="col-6 mt-2 mb-2">
                                        <span class="badge badge-warning">{{ presupuesto.EstadoPe }}</span>
                                    </div>
                                    <div class="col-6 mt-2 mb-2">
                                        {{ presupuesto.timestampModPe ? presupuesto.timestampModPe|date("F jS \\a\\t g:ia")  : '' }}
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="pt-3">Presupuesto de</h5>
                                <span>{{ presupuesto.clientePe.nombreCl }} {{ presupuesto.clientePe.apellidosCl }}</span>
                                <h5 class="mt-4">Direccion</h5>
                                <span>{{ presupuesto.clientePe.direccionCl }}</span>
                                <h5 class="mt-4">Telefono</h5>
                                <span>{{ presupuesto.clientePe.telefono1Cl }} - {{ presupuesto.clientePe.telefono2Cl }}</span>
                                <br/>
                            </div>
                        </div>
                        <div class="card">
                                <div class="card-body" id="loop"  data-cesta="{{ presupuesto.ticket.Id }}">
                                {% if presupuesto.EstadoPe.id < 7  %}
                                    {% include 'productos/loop.html.twig' %}
                                {% endif %}
                                </div>
                        </div>


                        {% if presupuesto.EstadoPe.id >= 5 %}
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Subir fotos</h4>
                                    {{ form_start(form) }}
                                        
                                            <div class="card-body">
                                            <h6 class="card-subtitle"></code></h6>
                                            <div class="action-form">
                                                <div class="form-group mb-0 text-left">
                                                    <button type="submit"  class="btn btn-info waves-effect waves-light">{{ button_label|default('Guardar Fotos') }}</button>
                                                </div>
                                            </div>
                                            <hr>
                                        
                                    {{ form_end(form) }}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Cambiar estado presupuesto</h4>
                                    {{ form_start(formestadopr) }}
                                        {{ form_row(formestadopr._token) }}
                                        
                                <div class="card-body">
                                            <h6 class="card-subtitle"></code></h6>
                                            <div class="action-form">
                                                <div class="form-group mb-0 text-left">
                                                    <button type="submit"  class="btn btn-info waves-effect waves-light">{{ button_label|default('Cambiar Estado') }}</button>
                                                </div>
                                            </div>
                                            <hr>
                                            {{ form_row(formestadopr.manoobraPe| raw, { 'row_attr': {'class': 'd-none'} }) }}
                                            {{ form_widget(formestadopr.estadoPe) }}
                                            {{ form_row(formestadopr.importetotPe, { 'attr': {'class': 'd-none' } ,'row_attr': {'class':'d-none'}} ) }}
                                            {{ form_row(formestadopr.descuaetoPe, { 'row_attr': {'class': 'd-none'} }) }}
                                            {{ form_row(formestadopr.importemanoobra, { 'row_attr': {'class': 'd-none'} }) }}
                                    {{ form_end(formestadopr, {'render_rest': false}) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row el-element-overlay">
                    {% for foto in fotos %}
        
                    <div class="col-lg-3 col-md-6">
                        <div class="card">
                            <div class="el-card-item pb-3">
                                <div class="el-card-avatar mb-3 el-overlay-1 w-100 overflow-hidden position-relative text-center"> <img src="{{ asset('Presupuestos/' ~ presupuesto.clientePe.nombreCl ~ ' ' ~ presupuesto.FechainiPe|date("Y-m-d") ~ '/fotos/' ~ foto) }}" class="d-block position-relative w-100" alt="user" />
                                    <div class="el-overlay w-100 overflow-hidden">
                                        <ul class="list-style-none el-info text-white text-uppercase d-inline-block p-0">
                                            <li class="el-item d-inline-block my-0  mx-1"><a class="btn default btn-outline image-popup-vertical-fit el-link text-white border-white" href="{{ asset('Presupuestos/' ~ presupuesto.clientePe.nombreCl ~ ' ' ~ presupuesto.FechainiPe|date("Y-m-d") ~ '/fotos/' ~ foto)}}"><i class="icon-magnifier"></i></a></li>
                                            <li class="el-item d-inline-block my-0  mx-1"><a class="btn default btn-outline el-link text-white border-white" href="javascript:void(0);"><i class="icon-link"></i></a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="el-card-content text-center">
                                    <h4 class="mb-0">{{ presupuesto.clientePe.nombreCl }} {{ presupuesto.clientePe.apellidosCl }}</h4> <span class="text-muted">{{ presupuesto.clientePe.direccionCl }}</span>
                                </div>
                            </div>

                        </div>
                    
                    </div>
                    {% endfor %}
                </div>

            <!-- ============================================================== -->
            <!-- End Container fluid  -->
            <!-- ============================================================== -->


{% endblock %}
{% block formulario %}{% endblock %}

{% block jscustom %}
    <!-- ============================================================== -->
    <!-- All Jquery -->
    <!-- ============================================================== -->
    <script src="{{ asset('assets/libs/jquery/dist/jquery.min.js') }}" ></script>
    <!-- Bootstrap tether Core JavaScript -->
    <script src="{{ asset('assets/libs/popper.js/dist/umd/popper.min.js') }}"></script>
    <script src="{{ asset('assets/libs/bootstrap/dist/js/bootstrap.min.js') }}"></script>
    <!-- apps -->
    <script src="{{ asset('dist/js/app.min.js') }}"></script>
    <script src="{{ asset('dist/js/app.init.js') }}"></script>
    <script src="{{ asset('dist/js/app-style-switcher.js') }}"></script>
    <!-- slimscrollbar scrollbar JavaScript -->
    <script src="{{ asset('assets/libs/perfect-scrollbar/dist/perfect-scrollbar.jquery.min.js') }}"></script>
    <script src="{{ asset('assets/extra-libs/sparkline/sparkline.js') }}"></script>
    <!--Wave Effects -->
    <script src="{{ asset('dist/js/waves.js') }}"></script>
    <!--Menu sidebar -->
    <script src="{{ asset('dist/js/sidebarmenu.js') }}"></script>
    <!--Custom JavaScript -->
    <script src="{{ asset('dist/js/feather.min.js') }}"></script>
    <script src="{{ asset('dist/js/custom.min.js') }}"></script>
    <!--This page plugins -->
    <script src="{{ asset('assets/libs/datatables/media/js/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('dist/js/pages/datatable/custom-datatable.js') }}"></script>
    <script src="{{ asset('dist/js/pages/datatable/datatable-api.init.js') }}"></script>
    <script src="{{ asset('assets/libs/sweetalert2/dist/sweetalert2.all.min.js') }}"></script>
    <script src="{{ asset('assets/extra-libs/sweetalert2/sweet-alert.init.js') }}"></script>

    <!--This page JavaScript -->
    <script src="{{ asset('assets/libs/magnific-popup/dist/jquery.magnific-popup.min.js') }}"></script>
    <script src="{{ asset('assets/libs/magnific-popup/meg.init.js') }}"></script>
    <script src="{{ asset('assets/libs/summernote/dist/summernote-bs4.min.js') }}"></script>


    <script language = "javascript">
        $(document).ready(function(){   

        //=============================================//
        //    DOM/jquery events                        //
        //=============================================//
        var table = $('#tbprod').DataTable();
        var selector = document.querySelector("#loop");
        var cestaId = selector.dataset.cesta

        /****************************************
        *      Generar presupuesto             *
        *****************************************/

        $(document).on('click', 'button[id="GENERAR"]' , async function(event) {

           // Datos de la fila seleccionada en la lista de productos
                var selector = document.querySelector('button[id="Generar"]');
                var tipo = selector.dataset.tipo;
                var data = table.row(this).data();

                const { value: accept } =  await Swal.fire({
                title: 'LISTAR PRECIOS',
                input: 'checkbox',
                inputValue: 0,
                inputPlaceholder:
                    '¿Quieres que salgan los precios?',
                confirmButtonText:
                    'Continuar <i class="fa fa-arrow-right"></i>',

                })

                if (accept) {
            // Pop up con datos del producto
                   location.href = "{{ path('presupuestos_generar', {id: presupuesto.id, 'precios' : 'S', 'tipo' : 'PRESUPUESTO' }) }}";
                   return;
                    
                } 
                location.href = "{{ path('presupuestos_generar', {id: presupuesto.id, 'precios' : 'N',  'tipo' : 'PRESUPUESTO' }) }}";


        })


        /****************************************
        *      Rechazar presupuesto             *
        *****************************************/

        $(document).on('click', 'button[id="Rechazar"]' , function(event) {

            location.href = "{{ path('presupuestos_finestado', {id: presupuesto.id, 'estado' : 12}) }}";

        })

        /****************************************
        *      Finalizar presupuesto             *
        *****************************************/
         $(document).on('click', 'button[id="Finalizar"]' , function(event) {

            $.ajax({  
                    url:        '{{ path("presupuestos_finalizar", {id:presupuesto.id  }) }}',  
                    type:       'GET',   
                    data:        ({}),
                    dataType:   'json',  
                    async:      true,  
                    
                    success: function(response) {  
                            location.reload();   
                    },  
                    error : function(xhr, textStatus, errorThrown) {  
                        alert(textStatus);  
                    }  
                    });


         })

        /****************************************
        *      Modificar presupuesto             *
        *****************************************/
         $(document).on('click', 'button[id="Modificar"]' , function(event) {
            const swalWithBootstrapButtons = Swal.mixin({
                customClass: {
                    confirmButton: 'btn btn-success',
                    cancelButton: 'mr-2 btn btn-danger'
                },
                buttonsStyling: false,
            })

            var selector = document.querySelector('button[id="Modificar"]');
            var importe = selector.dataset.importe;

                const inputValue = Number(importe * 0.30).toFixed(2)
                const importe2 = Number(importe).toFixed(2)
                const inputStep = 1

            swalWithBootstrapButtons.fire({
                title: 'Señal',
                text: "Importe total" ,
                type: 'warning',
                html: `
                    <h2> Cantidad  - ${importe2} €</h2> 
                    <input type="number" value="${inputValue}" step="${inputStep}" class="swal2-input" id="range-value" text-align="right">`,
                showCancelButton: true,
                confirmButtonText: 'Tarjeta',
                cancelButtonText: 'Efectivo',
                reverseButtons: true
            }).then((result) => {
                const inputNumber = Swal.getContent().querySelector('#range-value');
                importe = inputNumber.value;
                if (result.value) {

                  
                    modificar_presu(importe, "Tarjeta"); 
                    

                } else if (
                    // Read more about handling dismissals
                    result.dismiss === Swal.DismissReason.cancel
                ) {

                    modificar_presu(importe, "Efectivo"); 
                }

            })

         })

        function modificar_presu(importesenal, tipopago) 
        {
            $.ajax({  
                    url:        '{{ path("modificarpresu", {id:presupuesto.id  }) }}',  
                    type:       'GET',   
                    data:        ({tipopago : tipopago, importesenal : importesenal }),
                    dataType:   'json',  
                    async:      true,  
                    
                    success: function(response) {  
                            location.reload();   
                    },  
                    error : function(xhr, textStatus, errorThrown) {  
                        alert(textStatus);  
                    }  
                    });

        };  



       /*********************************************************
        *      Eliminar un detalle manod de obra                *
        ********************************************************/

        $(document).on('click', 'i[name="delete_detallemo"]' , async function(event) {
            let id = this.id;
                console.log (id);

            const swalWithBootstrapButtons = await Swal.mixin({
                customClass: {
                    confirmButton: 'btn btn-success',
                    cancelButton: 'mr-2 btn btn-danger'
                },
                buttonsStyling: false,
            })

            await swalWithBootstrapButtons.fire({
                title: 'Borrado de mano de obra',
                text: "Se va a borrar la moano de obra " + id + " ",
                type: 'question',
                showCancelButton: true,
                confirmButtonText: 'Adelante',
                cancelButtonText: 'Noooo',
                reverseButtons: true
            }).then((result) => {
                
                if (result.value) {

                    delete_line_mo(id);
                }
            })
        })

        function delete_line_mo(id) 
        {
            $.ajax({  
               url:        '{{path("manoobra_delete_ajax")}}',  
               type:       'GET',   
               data:        ({id: id}),
               dataType:   'json',  
               async:      true,  
               
               success: function(response) { 
                    let timerInterval
                    Swal.fire({
                    type: 'success',
                    title: 'Se ha borrado correctamente!',
                    html: 'Se cerrara en breve',
                    timer: 2000,
                    showConfirmButton: false,
                    timerProgressBar: true,
                    willClose: () => {
                        clearInterval(timerInterval)
                    }
                    }).then((result) => {
                    /* Read more about handling dismissals below */
                    if (result.dismiss === Swal.DismissReason.timer) {
                        location.reload();
                    }
                    })
                   
               },  
               error : function(xhr, textStatus, errorThrown) {  
                  alert(textStatus);  
               }  
            }); 
        };          


       /****************************************
        *      Eliminar un producto             *
        *****************************************/

        $(document).on('click', 'i[name="delete_detalle"]' , function(event) {
            let id = this.id;
            delete_line(id);
        })
        

        function delete_line(id) 
        {
            $.ajax({  
               url:        '{{path("detallecesta_delete")}}',  
               type:       'GET',   
               data:        ({id: id}),
               dataType:   'json',  
               async:      true,  
               
               success: function(response) {  
                   $('#loop').html(response.template);
                   document.querySelector("span[name='cantidad']").innerText     =  response.cantidad;
               },  
               error : function(xhr, textStatus, errorThrown) {  
                  alert(textStatus);  
               }  
            }); 
        };  



        /****************************************
        *      Finalizar ticket                 *
        *****************************************/
        function abrirNuevoTab(url) {
            // Abrir nuevo tab
            var win = window.open(url, '_blank');
            // Cambiar el foco al nuevo tab (punto opcional)
            win.focus();
        }
        
         $(document).on('click', 'button[id="Checkout"]' , function(event) {

            var selector = document.querySelector("#idpresu");
            var idpresupuesto = "";
            ticket_pdf(idpresupuesto) ;

         })

        function ticket_pdf(cestaId) 
        {
            
            $.ajax({  
                    url:        '{{ path("presupuestopdf") }}',  
                    type:       'GET',   
                    data:        ({id : cestaId}),
                    dataType:   'json',  
                    async:      true,  
                    
                    success: function(response) {  

                            abrirNuevoTab('/Presupuestos/' + response.namepdf);
                            
                    },  
                    error : function(xhr, textStatus, errorThrown) {  
                        alert(textStatus);  
                    }  
                    });

        }; 

           
        /****************************************
        *       Insertar un producto      *
        ****************************************/

        $('#tbprod').on('click', 'tbody tr[role="row"]', function() {
                var data = table.row(this).data();
                const inputValue = 1
                const inputValue2 = data[4]
                const inputValue3 = data[3]
                const inputStep = 1
                const inputStep2 = 1
                const inputText = ""
                const inputValue0 = data[2]

                Swal.fire({
                title: 'Cantidad y PVP',
                html: `
                     <h1> "${inputValue0}" </h1>
                    <input type="text" value="${inputText}" class="swal2-input" id="range-value0" text-align="center">
                    <h2> Cantidad </h2>
                    <input type="number" value="${inputValue}" step="${inputStep}" class="swal2-input" id="range-value">
                    <h2> PVP </h2>
                    <input type="number" value="${inputValue2}" step="${inputStep2}" class="swal2-input" id="range-value2">
                    <h2> Coste </h2>
                    <input type="number" value="${inputValue3}" step="${inputStep2}" class="swal2-input" id="range-value3">`,

                }).then((result) => {
                    if (result.value) {
                        var data = table.row(this).data();
                        const inputText = Swal.getContent().querySelector('#range-value0');
                        texto = inputText.value;
                        const inputNumber = Swal.getContent().querySelector('#range-value');
                        cantidad = inputNumber.value;
                        const inputNumber2 = Swal.getContent().querySelector('#range-value2');
                        importe = inputNumber2.value;
                        const inputNumber3 = Swal.getContent().querySelector('#range-value3');
                        coste = inputNumber3.value;
                        insert_line(data,cantidad,importe,coste,cestaId,texto);
                    }
                })

         })

        function insert_line(producto,cantidad,importe,coste,cesta,texto) 
        {
            $.ajax({  
               url:        '{{path("detallecesta_new") }}',   
               type:       'GET',   
               data:        ({producto: producto, cantidad:cantidad, importe:importe, coste:coste, cesta:cesta, texto:texto}),
               dataType:   'json',  
               async:      true,  
               
               success: function(response) {  
                    $('#loop').html(response.template);

               },  
               error : function(xhr, textStatus, errorThrown) {  
                  alert(textStatus);  
               }  
            });  
        };  

        /****************************************
        *       Presupuesto Aceptado           *
        *****************************************/

         $(document).on('click', 'button[id="Aceptar"]' , function(event) {
            const swalWithBootstrapButtons = Swal.mixin({
                customClass: {
                    confirmButton: 'btn btn-success',
                    cancelButton: 'mr-2 btn btn-danger'
                },
                buttonsStyling: false,
            })

            var selector = document.querySelector('button[id="Aceptar"]');
            var importe = selector.dataset.importe;

                const inputValue = Number(importe * 0.30).toFixed(2)
                const importe2 = Number(importe).toFixed(2)
                const inputStep = 1

            swalWithBootstrapButtons.fire({
                title: 'Señal',
                text: "Importe total" ,
                type: 'warning',
                html: `
                    <h2> Cantidad  - ${importe2} €</h2> 
                    <input type="number" value="${inputValue}" step="${inputStep}" class="swal2-input" id="range-value" text-align="right">`,
                showCancelButton: true,
                confirmButtonText: 'Tarjeta',
                cancelButtonText: 'Efectivo',
                reverseButtons: true
            }).then((result) => {
                const inputNumber = Swal.getContent().querySelector('#range-value');
                importe = inputNumber.value;
                if (result.value) {

                  
                    aceptar_presu(importe, "Tarjeta"); 
                    

                } else if (
                    // Read more about handling dismissals
                    result.dismiss === Swal.DismissReason.cancel
                ) {

                    aceptar_presu(importe, "Efectivo"); 
                }

            })

         })



        function aceptar_presu(importesenal, tipopago) 
        {
            $.ajax({  
                    url:        '{{ path("aceptarpresu", {id:presupuesto.id  }) }}',  
                    type:       'GET',   
                    data:        ({tipopago : tipopago, importesenal : importesenal }),
                    dataType:   'json',  
                    async:      true,  
                    
                    success: function(response) {  
                            location.reload();   
                    },  
                    error : function(xhr, textStatus, errorThrown) {  
                        alert(textStatus);  
                    }  
                    });

        };  



        
        /****************************************
        *       Sumar o restar un producto      *
        *****************************************/

        $(document).on('click', 'i[name="plus-minus"]' , function(event) {
            let id = this.id;
            this.dataset.cantidad;

            let cantidad = this.dataset.cantidad;

            if (this.classList.contains("fa-minus-circle")){
                cantidad--;
            }else{
                cantidad++;
            };

            if (cantidad==0) {
                delete_line(id);     
            }else{
                actualiza_line(id, cantidad);
            }

        })




        function actualiza_line(id,cantidad) 
        {
            $.ajax({  
               url:        '../detallecesta/plusminus/ajax',  
               type:       'GET',   
               data:        ({cantidad: cantidad ,id: id}),
               dataType:   'json',  
               async:      true,  
               
               success: function(response) {  
                   $('#loop').html(response.template);
                   document.querySelector("span[name='cantidad']").innerText     =  response.cantidad;
               },  
               error : function(xhr, textStatus, errorThrown) {  
                  alert(textStatus);  
               }  
            });  
        };  


        /****************************************
        *       ACTUACION SOBRE ECONOMICS       *
        *****************************************/

        $(document).on('click', 'i[name="no_aplica"]' , function(event) {
            let id = this.id;
            let estado = this.dataset.estado;            

            $.ajax({  
               url:        '../economicpresu/estado/ajax',  
               type:       'GET',   
               data:        ({estado:estado ,id:id}),
               dataType:   'json',  
               async:      true,  
               
               success: function(response) {  
                   location.reload();   
               },  
               error : function(xhr, textStatus, errorThrown) {  
                  alert(textStatus);  
               }  
            });  
            });

        $(document).on('click', 'i[name="cambiar_importe"]' , function(event) {

            let id = this.id;
            let importe = this.dataset.importe;     

            const inputValue = Number(importe).toFixed(2);
                const importe2 = 0;
                const inputStep = 1;
    
            const swalWithBootstrapButtons = Swal.mixin({
                customClass: {
                    confirmButton: 'btn btn-success',
                    cancelButton: 'mr-2 btn btn-danger',
                    denyButton: 'mr-2 btn btn-danger'
                },
                buttonsStyling: false,

            })




            swalWithBootstrapButtons.fire({
             
             
                title: 'IMPORTE',
                text: "Importe total" ,
                type: 'question',
                html: `
                    <input type="number" value="${inputValue}" step="${inputStep}" class="swal2-input" id="range-value" text-align="right">`,
                showCancelButton: true,
                confirmButtonText: 'Modificar',
                cancelButtonText: 'Pagar',
                reverseButtons: true
                }).then((result) => {
                const inputNumber = Swal.getContent().querySelector('#range-value');
                importe = inputNumber.value;
                if (result.value) {

                  
                   actualiza_importe(id,importe); 
                    

                } else if (
                    // Read more about handling dismissals
                    result.dismiss === Swal.DismissReason.cancel
                ) {
                   pagar_economic(id,importe,"Efectivo"); 
                }

            })
            });     

            function actualiza_importe (id,importe) 
            {
                $.ajax({  
                url:        '../economicpresu/importe/ajax',  
                type:       'GET',   
                data:        ({importe:importe ,id:id}),
                dataType:   'json',  
                async:      true,  
                
                success: function(response) {  
                    location.reload();   
                },  
                error : function(xhr, textStatus, errorThrown) {  
                    alert(textStatus);  
                }                      
                });
            };

            function pagar_economic(id,importe,modo) 
            {
                $.ajax({  
                url:        '../economicpresu/pagar/ajax',  
                type:       'GET',   
                data:        ({importe:importe, id:id, modo:modo}),
                dataType:   'json',  
                async:      true,  
                
                success: function(response) {  
                    location.reload();   
                },  
                error : function(xhr, textStatus, errorThrown) {  
                    alert(textStatus);  
                }                      
                });
            };



            $(document).on('click', 'i[name="ticket_material"]' , function(event) {
                const swalWithBootstrapButtons = Swal.mixin({
                    customClass: {
                        confirmButton: 'btn btn-success',
                        cancelButton: 'mr-2 btn btn-danger'
                    },
                    buttonsStyling: false,
                })
                let importe = this.dataset.importe;  
                let id = this.id;        

                const inputValue = Number(importe).toFixed(2)
                const importe2 = Number(importe).toFixed(2)
                const inputStep = 1

                swalWithBootstrapButtons.fire({
                    title: 'Señal',
                    text: "Importe total" ,
                    type: 'warning',
                    html: `
                        <h2> Cantidad  - ${importe2} €</h2> 
                        <input type="number" value="${inputValue}" step="${inputStep}" class="swal2-input" id="range-value" text-align="right">`,
                    showCancelButton: true,
                    confirmButtonText: 'Tarjeta',
                    cancelButtonText: 'Efectivo',
                    reverseButtons: true
                }).then((result) => {
                    const inputNumber = Swal.getContent().querySelector('#range-value');
                    importe = inputNumber.value;
                    if (result.value) {
                        cobrar_presu(importe, "Tarjeta",id); 
                    } else if (
                        // Read more about handling dismissals
                        result.dismiss === Swal.DismissReason.cancel
                    ) {
                        cobrar_presu(importe, "Efectivo",id);
                    }

            })

         })



        function cobrar_presu(importesenal, tipopago, id) 
        {
            $.ajax({  
                    url:        '{{ path("cobrarpresu", {id:presupuesto.id  }) }}',  
                    type:       'GET',   
                    data:        ({tipopago : tipopago, importesenal : importesenal, id:id}),
                    dataType:   'json',  
                    async:      true,  
                    
                    success: function(response) {  
                            location.reload();   
                    },  
                    error : function(xhr, textStatus, errorThrown) {  
                        alert(textStatus);  
                    }  
                    });

        };           

            $(document).on('click', 'i[name="ticket_mano"]' , function(event) {
                const swalWithBootstrapButtons = Swal.mixin({
                    customClass: {
                        confirmButton: 'btn btn-success',
                        cancelButton: 'mr-2 btn btn-danger'
                    },
                    buttonsStyling: false,
                })
                let importe = this.dataset.importe;  
                let id = this.id;        

                const inputValue = Number(importe).toFixed(2)
                const importe2 = Number(importe).toFixed(2)
                const inputStep = 1

                swalWithBootstrapButtons.fire({
                    title: 'Señal',
                    text: "Importe total" ,
                    type: 'warning',
                    html: `
                        <h2> Cantidad  - ${importe2} €</h2> 
                        <input type="number" value="${inputValue}" step="${inputStep}" class="swal2-input" id="range-value" text-align="right">`,
                    showCancelButton: true,
                    confirmButtonText: 'Tarjeta',
                    cancelButtonText: 'Efectivo',
                    reverseButtons: true
                }).then((result) => {
                    const inputNumber = Swal.getContent().querySelector('#range-value');
                    importe = inputNumber.value;
                    if (result.value) {
                        cobrar_mano(importe, "Tarjeta",id); 
                    } else if (
                        // Read more about handling dismissals
                        result.dismiss === Swal.DismissReason.cancel
                    ) {
                        cobrar_mano(importe, "Efectivo",id);
                    }

            })

         })

        function cobrar_mano(importe, tipopago, id) 
        {
            $.ajax({  
                    url:        '{{ path("cobrarmanopresu", {id:presupuesto.id  }) }}',  
                    type:       'GET',   
                    data:        ({tipopago : tipopago, importe : importe, id:id}),
                    dataType:   'json',  
                    async:      true,  
                    
                    success: function(response) {  
                            location.reload();   
                    },  
                    error : function(xhr, textStatus, errorThrown) {  
                        alert(textStatus);  
                    }  
                    });

        };       
              
       });  

        /************************************/
        //default editor
        /************************************/
        $('.summernote').summernote({
            height: 350, // set editor height
            minHeight: null, // set minimum height of editor
            maxHeight: null, // set maximum height of editor
            focus: false // set focus to editable area after initializing summernote
        });

        /************************************/
        //inline-editor
        /************************************/
        $('.inline-editor').summernote({
            airMode: true
        });

        /************************************/
        //edit and save mode
        /************************************/
        window.edit = function () {
            $(".click2edit").summernote()
        },
            window.save = function () {
                $(".click2edit").summernote('destroy');
            }

        var markupStr = $('#summernote').summernote('code');

        var edit = function () {
            $('.click2edit').summernote({ focus: true });
        };

        var save = function () {
            var markupStr = $('.click2edit').summernote('code');
            $('.click2edit').summernote('destroy');
                var selector = document.querySelector("#idpresu");
                var actualpre = selector.dataset.idpresu;

                $.ajax({  
                    url:        '../presupuestos/' + actualpre + '/manoobra',  
                    type:       'GET',   
                    data:        ({texto : markupStr}),
                    dataType:   'json',  
                    async:      true,  
                    
                    success: function(response) {  
                        console.log(actualpre);
                        location.reload();                                 
                    },  
                    error : function(xhr, textStatus, errorThrown) {  
                        alert(textStatus);  
                    }  
                    });
        };

        /************************************/
        //airmode editor
        /************************************/
        $('.airmode-summer').summernote({
            airMode: true
        });





    </script>
{% endblock %}